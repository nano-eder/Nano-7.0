SET DATEFORMAT dmy SELECT Produto.CodigoFabricante as CodSimilar, Produto.Codigo, Produto.Nome, Produto.UnidadeMedida, Convert(Numeric(15,3), Produto.Valor) as Valor, Convert(Numeric(15,3), Produto.ValorCusto) as ValorCusto, (select Locacao from Locacao where Locacao.CodProd = Produto.Codigo and Locacao.CodConfig  = 1) as Locacao, Produto.CodigoInterno, Produto.Porcentagens, Produto.Fabricante, Produto.Familia, Produto.Grupo, Produto.Obs, Produto.Data, Produto.CodigoBarra, Produto.CodProdFor, Produto.Validade, (SELECT sum(Convert(Numeric(15,3), Qtde.QtdMinima)) FROM Qtde where Qtde.CodConfig = 1 and Produto.Codigo = Qtde.CodProd) as QtdMinima, (SELECT case when sum(EntradaNf.QtdProd) is null then 0 else sum(EntradaNf.QtdProd) end FROM EntradaNf left join TotalEntradaNf on EntradaNf.CodTotNf = TotalEntradaNf.Codigo where EntradaNf.CodProd = Produto. Codigo and EstoqueOk = 'True' and EntradaNf.CodConfig = 1) - (SELECT case when sum(Pedido.Qtd) is null then 0 else sum(Pedido.Qtd) end FROM Pedido left join Total on Pedido.CodOrdem = Total.CodOrdem and PEdido.CodConfig = Total.CodConfig where Pedido.CodConfig = 1 and Pedido.CodProd = Produto.Codigo and Pedido.Devolvido = 'False') + (SELECT case when sum(AjusteQtde.Qtd) is null then 0 else  sum(AjusteQtde.Qtd) end FROM AjusteQtde where AjusteQtde.CodConfig = 1 and AjusteQtde.CodProd = Produto.Codigo) as Qtd, (SELECT Case when sum(Convert(Numeric(15,3), ItensConsig.Qtd)) is Null then 0 else sum(Convert(Numeric(15,3), ItensConsig.Qtd)) End FROM ItensConsig left join TotalConsig on ItensConsig.CodOrdens = TotalConsig.CodOrdens and ItensConsig.CodConfig = TotalConsig.CodConfig where TotalConsig.Status = 'Pendente' and ItensConsig.CodConfig = 1 and Produto.Codigo = ItensConsig.CodigoProduto) as EmPedido, case when ((SELECT case when sum(EntradaNf.QtdProd) is null then 0 else sum(EntradaNf.QtdProd) end FROM EntradaNf left join TotalEntradaNf on EntradaNf.CodTotNf = TotalEntradaNf.Codigo where EntradaNf.CodProd = Produto. Codigo and EstoqueOk = 'True' and EntradaNf.CodConfig = 1) - (SELECT case when sum(Pedido.Qtd) is null then 0 else sum(Pedido.Qtd) end FROM Pedido left join Total on Pedido.CodOrdem = Total.CodOrdem and PEdido.CodConfig = Total.CodConfig where Pedido.CodConfig = 1 and Pedido.CodProd = Produto.Codigo and Pedido.Devolvido = 'False') + (SELECT case when sum(AjusteQtde.Qtd) is null then 0 else  sum(AjusteQtde.Qtd) end FROM AjusteQtde where AjusteQtde.CodConfig = 1 and AjusteQtde.CodProd = Produto.Codigo)) < 0 then (SELECT Case when sum(Convert(Numeric(15,3), ItensConsig.Qtd)) is Null then 0 else sum(Convert(Numeric(15,3), ItensConsig.Qtd)) End FROM ItensConsig left join TotalConsig on ItensConsig.CodOrdens = TotalConsig.CodOrdens and ItensConsig.CodConfig = TotalConsig.CodConfig where TotalConsig.Status = 'Pendente' and ItensConsig.CodConfig = 1 and Produto.Codigo = ItensConsig.CodigoProduto) + ((SELECT case when sum(EntradaNf.QtdProd) is null then 0 else sum(EntradaNf.QtdProd) end FROM EntradaNf left join TotalEntradaNf on EntradaNf.CodTotNf = TotalEntradaNf.Codigo where EntradaNf.CodProd = Produto. Codigo and EstoqueOk = 'True' and EntradaNf.CodConfig = 1) - (SELECT case when sum(Pedido.Qtd) is null then 0 else sum(Pedido.Qtd) end FROM Pedido left join Total on Pedido.CodOrdem = Total.CodOrdem and PEdido.CodConfig = Total.CodConfig where Pedido.CodConfig = 1 and Pedido.CodProd = Produto.Codigo and Pedido.Devolvido = 'False') + (SELECT case when sum(AjusteQtde.Qtd) is null then 0 else  sum(AjusteQtde.Qtd) end FROM AjusteQtde where AjusteQtde.CodConfig = 1 and AjusteQtde.CodProd = Produto.Codigo)) else ((SELECT case when sum(EntradaNf.QtdProd) is null then 0 else sum(EntradaNf.QtdProd) end FROM EntradaNf left join TotalEntradaNf on EntradaNf.CodTotNf = TotalEntradaNf.Codigo where EntradaNf.CodProd = Produto. Codigo and EstoqueOk = 'True' and EntradaNf.CodConfig = 1) - (SELECT case when sum(Pedido.Qtd) is null then 0 else sum(Pedido.Qtd) end FROM Pedido left join Total on Pedido.CodOrdem = Total.CodOrdem and PEdido.CodConfig = Total.CodConfig where Pedido.CodConfig = 1 and Pedido.CodProd = Produto.Codigo and Pedido.Devolvido = 'False') + (SELECT case when sum(AjusteQtde.Qtd) is null then 0 else  sum(AjusteQtde.Qtd) end FROM AjusteQtde where AjusteQtde.CodConfig = 1 and AjusteQtde.CodProd = Produto.Codigo)) - (SELECT Case when sum(Convert(Numeric(15,3), ItensConsig.Qtd)) is Null then 0 else sum(Convert(Numeric(15,3), ItensConsig.Qtd)) End FROM ItensConsig left join TotalConsig on ItensConsig.CodOrdens = TotalConsig.CodOrdens and ItensConsig.CodConfig = TotalConsig.CodConfig where TotalConsig.Status = 'Pendente' and ItensConsig.CodConfig = 1 and Produto.Codigo = ItensConsig.CodigoProduto) end as Saldo, (SELECT Case when sum(Convert(Numeric(15,3), Qtde.EmFalta)) is Null then 1 else sum(Convert(Numeric(15,3), Qtde.EmFalta)) End FROM Qtde where Qtde.Acabou = 'False' and Qtde.CodConfig = 1 and Produto.Codigo = Qtde.CodProd) as EmFalta, Produto.NivelComboCodCF, Produto.Desconto, (SELECT Max(Total.Data) FROM Total left join Pedido on Total.CodOrdem = Pedido.CodOrdem and Total.CodConfig = Pedido.CodConfig where Pedido.CodProd = Produto.Codigo and Pedido.CodConfig = 1) as DataUltVenda, Produto.Setor, Produto.Tipo, Produto.Inativo, Produto.Comissao, Produto.Locacao2, Produto.Familia, convert(bit,(SELECT case when sum(Codigo) > 0 then 'True' else 'False' end FROM Campanha where Campanha.CodProd = Produto.Codigo and Status = 'Lancado')) as Campanha, case when Produto.Desconto > 0 then convert(Numeric(15,3),(Produto.Valor - ((Produto.Valor / 100) * Produto.Desconto))) else NULL end as ValPromocao, Produto.QtdEmb FROM Produto left join Qtde on Produto.Codigo = Qtde.CodProd where Produto.Inativo = 'False'  group by Produto.Familia, Produto.Codigo, Produto.Nome, Produto.UnidadeMedida, Produto.Valor, Produto.ValorCusto, Produto.CodigoInterno, Produto.Porcentagens, Produto.Fabricante, Produto.Grupo, Produto.Obs, Produto.Data, Produto.CodigoBarra, Produto.NivelComboCodCF, Produto.Desconto, Produto.Setor, Produto.Tipo, Produto.Inativo, Produto.CodProdFor, Produto.Validade, Produto.Comissao, Produto.Locacao2, Produto.CodigoFabricante, Produto.Familia, Produto.QtdEmb
